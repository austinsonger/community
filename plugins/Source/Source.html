<style>
    #right-sidebar-readme pre code {
        padding: 0;
        box-shadow: none;
        background: none;
    }
    #right-sidebar-readme pre {
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    #right-sidebar-readme a {
        color: #fff;
    }
    .source-blocks {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        flex-wrap: wrap;
        grid-gap: 10px;
    }
    .source-blocks .section {
        flex-direction: column;
        flex: 30%;
    }
    .source-blocks .section .block {
        background-color: #10100f;
        padding: 0 10px;
        border-radius: 4px;
    }
    .source-blocks .section .block .header-info {
        margin-top: 20px;
    }
    .source-blocks .section .block .header-info .name {
        color: #999;
        display: block;
        font-family: PF Din Mono;
        font-size: 12px;
        font-style: normal;
        font-weight: 600;
        letter-spacing: 2px;
        line-height: 11px;
        margin: 0 0 10px;
        padding: 0;
        text-decoration: none;
        text-transform: uppercase;
    }
    .boxed-selector .description {
        display: block;
        color: #999;
        font-family: 'ITC Franklin Gothic Std';
        font-size: 14px;
        font-weight: 100;
        margin-top: 10px;
    }
    .input-wrapper .main {
        color: #999;
        display: block;
        font-family: PF Din Mono;
        font-size: 11px;
        font-style: normal;
        font-weight: 600;
        letter-spacing: 2px;
        line-height: 11px;
        margin: 0 0 10px 0;
        padding: 0;
        text-decoration: none;
        text-transform: uppercase;
    }
</style>
<div id="source-code-container" class="loader-container">
    <div class="profile-heading-container">
        <div class="body">
            <strong class="profile-heading">Download source code</strong>
            <p>
                Download source code for various Prelude respositories.
            </p>
        </div>
    </div>
    <div id="source-blocks-section" class="source-blocks"></div>
    <div class="loader"></div>
</div>

<div id="source-block-template" class="section">
    <div class="block">
        <div class="header-info">
            <span class="name"></span>
        </div>
        <ul class="source-list"></ul>
    </div>
</div>

<li id="source-code-item-template" class="input-wrapper" style="display: none; background-color: #000000;">
    <div class="boxed-selector">
        <strong id="code-name" class="main"></strong>
        <span id="code-description" class="description"></span>
    </div>
</li>

<div id="right-sidebar-readme" class="right-sidebar-half loader-container doc-block" style="display:none">
    <div id="readme"></div>
    <div class="loader"></div>
</div>

<script>
    const handleDownloadSource = (package) => {
        $('#source-code-container .loader').toggleClass('loading', true);
        function getDownloadDir() {
            switch (os.platform()) {
                case 'darwin':
                    return `${process.env.HOME}/Downloads`
                case 'linux':
                    return '/tmp'
                case 'win32':
                    return 'C:\\Users\\Public'
            }
        }

        Requests.hq.getPayload(package).then((res) => {
            if (res.status === 200) {
                return res.blob()
            }
        })
        .then((blob) => blob.arrayBuffer())
        .then((data) => {
            let dir = getDownloadDir()
            let target = path.join(dir, package.split('/').pop())
            Basic.storeData(Buffer.from(data), target)
            fs.chmodSync(target, '755')
            Basic.showNotification('Downloaded File', `Downloaded ${package} to ${dir}`)
        })
        .catch((e) => Basic.showNotification('Download Failed', `Could not download ${package}`))
        .finally(() => $('#source-code-container .loader').toggleClass('loading', false));
    };

    Requests.hq.getPayloads().then((payloads) => {
        console.log(payloads);
        const cloneNewBlock = (purpose) => {
            let clone = $(`#source-block-template`).clone();
            clone.prop('id', `${purpose}-source-block`);
            clone.find('.block .name').text(`${purpose} source`);
            clone.css('display', 'flex');
            $('#source-blocks-section').append(clone);
            return clone;
        }
        Object.keys(payloads).filter(a => a.includes('-source.zip')).forEach(a => {
            let block = $(`#${payloads[a]?.metadata?.purpose}-source-block`);
            block = block.length !==0 ? block : cloneNewBlock(payloads[a]?.metadata?.purpose || 'data');
            let codeTemplate = $('#source-code-item-template').clone();
            codeTemplate.prop('id', a);
            codeTemplate.find('#code-name').text(payloads[a]?.shortname || a);
            codeTemplate.find('#code-description').text(payloads[a]?.metadata?.description || 'No description found');
            codeTemplate.on('click', (ev) => handleDownloadSource(a));
            codeTemplate.show();
            block.find('.source-list').append(codeTemplate);
        });
    });
</script>
